var Request = require('request'),
    Enums = require('./enums'),
    Constants = require('./constants'),
    _ = require('./utils'),
    deasync = require('deasync');

/**
 * VoiceEvent constructor
 * @constructor
 * @param  {String} name String containing the event name (ex: INITIALIZE, SESSION_START, etc...)
 * @param  {Object} data Object containing metadata for the event
 * @return {Void}
 */
var VoiceEvent = function(name, data){
  if(!Enums.eventTypes[name]){
    throw '[VoiceInsights ERROR] Event type is not supported: ' + name;
  }

  if(!data){
    data = {};
  }

  this.name = name;
  this.data = data;
  this.data.event_type = name;
}

_.extend(VoiceEvent.prototype, {
  /**
   * Post action to events API endpoint
   * @param  {Function} callback Callback function to execute once request has finished
   * @return {Void}
   */
  send: function(callback){

    //MAKE THIS a DEASYNC call -- either this or 'trigger()'

    var URL = Constants.authURL(Constants.api.baseURL + Constants.api.eventsAPI, this.data.app_token);

    Request.post(URL, { timeout: 1500, json: this.data }, function(error, response, body){
      var status = response ? response.statusCode : 500
          output = {
            status: status
          };

      if(_.isFunction(callback)){
        if(!error && status >= 200 && status < 300 || status === 304){
          output.response = body;
        }else{
          output.reponse = error || body;
        }

        callback(output);
      }
    });
  }
});

module.exports = VoiceEvent;
